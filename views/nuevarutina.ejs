<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Rutina</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/CSSNuevaRutina.css" rel="stylesheet">

    <style>
        .navbar-custom { background-color: #c3b1e1; }
        .footer { background-color: #c3b1e1; padding: 2rem 1rem; }
        .opcion-ejercicio { display: flex; gap: 10px; padding: 5px; }
    </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="/index">
            <span class="fw-bold">Nueva Rutina</span>
        </a>

        <div class="collapse navbar-collapse justify-content-end">
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                        <b>Menú</b>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/nueva_rutina">Nueva rutina</a></li>
                        <li><a class="dropdown-item" href="/ejercicios">Ejercicios</a></li>
                        <li><a class="dropdown-item" href="/rutinas">Rutinas</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="/logout">Salir</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- CONTENIDO -->
<main class="container my-5">
    <div class="row g-5">

        <!-- IZQUIERDA (categorías y ejercicios) -->
        <div class="col-lg-4">
            <label class="form-label">Músculo</label>
            <select class="form-select" id="select-musculo-filtro">
                <option value="todos">Todos los músculos</option>
                <option value="1">Pecho</option>
                <option value="2">Espalda</option>
                <option value="3">Piernas</option>
                <option value="4">Brazos</option>
                <option value="5">Hombros</option>
                <option value="6">Glúteos</option>
                <option value="7">Abdomen</option>
            </select>

            <div id="contenedor-ejercicios-disponibles" class="mt-3 p-2 border rounded">
                <p class="text-center text-muted">Cargando ejercicios...</p>
            </div>
        </div>

        <!-- DERECHA (tabla y botón guardar) -->
        <div class="col-lg-8">

            <label class="form-label">Nombre de la rutina</label>
            <input type="text" id="input-nombre-rutina" class="form-control" placeholder="Ej: Rutina Pecho Lunes">

            <div class="table-responsive mt-4">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Ejercicio</th>
                            <th>Reps</th>
                            <th>Descanso (seg)</th>
                            <th>Series</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-nueva-rutina-body"></tbody>
                </table>
            </div>

            <button class="btn btn-success mt-3" id="btn-crear-rutina">+ Crear Rutina</button>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- JS: cargar ejercicios -->
<script>
const selectMusculo = document.getElementById("select-musculo-filtro");
const contenedor = document.getElementById("contenedor-ejercicios-disponibles");
const tabla = document.getElementById("tabla-nueva-rutina-body");

//  Cargar ejercicios al inicio
cargarEjercicios("todos");

selectMusculo.addEventListener("change", () => {
    cargarEjercicios(selectMusculo.value);
});

function cargarEjercicios(categoria) {
    contenedor.innerHTML = `<p class="text-center text-muted">Cargando ejercicios...</p>`;

    fetch(`/api/ejercicios?categoria=${categoria}`)
        .then(res => res.json())
        .then(data => {
            contenedor.innerHTML = "";

            if (data.length === 0) {
                contenedor.innerHTML = `<p class="text-center">No hay ejercicios.</p>`;
                return;
            }

            data.forEach(ej => {
                contenedor.innerHTML += `
                    <div class="opcion-ejercicio">
                        <input type="checkbox" value="${ej.id_ejercicio}" data-nombre="${ej.nombre}">
                        <label>${ej.nombre}</label>
                    </div>
                `;
            });
        });
}

// Agregar o quitar de la tabla
contenedor.addEventListener("change", (e) => {
    if (e.target.type === "checkbox") {
        if (e.target.checked) {
            agregarEjercicioATabla(e.target.value, e.target.dataset.nombre);
        } else {
            quitarEjercicioDeTabla(e.target.value);
        }
    }
});

function agregarEjercicioATabla(id, nombre) {
    tabla.insertAdjacentHTML("beforeend", `
        <tr id="fila-${id}">
            <td>${nombre}</td>
            <td><input type="number" value="10" class="form-control"></td>
            <td><input type="number" value="60" class="form-control"></td>
            <td><input type="number" value="3" class="form-control"></td>
        </tr>
    `);
}

function quitarEjercicioDeTabla(id) {
    const fila = document.getElementById(`fila-${id}`);
    if (fila) fila.remove();
}

// Crear rutina
document.getElementById("btn-crear-rutina").addEventListener("click", () => {
    const nombre = document.getElementById("input-nombre-rutina").value.trim();

    if (!nombre) return alert("Escribe un nombre para la rutina.");

    const ejercicios = [];

    tabla.querySelectorAll("tr").forEach(row => {
        const id = row.id.replace("fila-", "");
        const reps = row.children[1].querySelector("input").value;
        const descanso = row.children[2].querySelector("input").value;
        const series = row.children[3].querySelector("input").value;

        ejercicios.push({
            id_ejercicio: id,
            repeticiones: reps,
            descanso_segundos: descanso,
            series: series
        });
    });

    if (ejercicios.length === 0) {
        return alert("Selecciona al menos un ejercicio.");
    }

    fetch("/api/crear_rutina", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nombre, ejercicios })
    })
    .then(r => r.json())
    .then(res => {
        if (res.success) {
            alert("Rutina creada correctamente");
            window.location.href = "/rutinas";
        } else {
            alert("Error creando rutina");
        }
    });
});
</script>

<footer class="footer"></footer>
</body>
</html>
